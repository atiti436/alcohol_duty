<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…’é¡é€²å£ç¨…é‡‘è¨ˆç®—æ©Ÿ - æ—…å®¢ç‰ˆ</title>
    <style>
        :root {
            --text-color: #333;
            --bg-color: #F5F5F5;
            --card-bg: #fff;
            --border-color: #ddd;
            --primary-color: #006C5E;
            --accent-color: #00A896;
            --error-color: #dc3545;
            --info-color: #028174;
            --warning-color: #E68A00;
            --light-green: #E8F9F6;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--bg-color);
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .card h2 {
            margin-bottom: 15px;
            color: var(--primary-color);
            font-size: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 14px;
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -10px;
        }

        .col {
            flex: 1;
            padding: 0 10px;
            min-width: 200px;
        }

        .col-full {
            flex: 100%;
            padding: 0 10px;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 10px;
        }

        button:hover {
            opacity: 0.9;
        }

        .btn-success {
            background-color: var(--accent-color);
        }

        .btn-danger {
            background-color: var(--error-color);
            width: auto;
            padding: 8px 15px;
            font-size: 14px;
            margin-top: 0;
        }

        .btn-add {
            background-color: var(--accent-color);
            font-size: 18px;
            padding: 12px;
        }

        /* å…ç¨…é¡é¡¯ç¤º */
        .duty-free-info {
            background-color: #006C5E;
            color: white;
            padding: 18px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .duty-free-info h3 {
            font-size: 16px;
            margin-bottom: 12px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .duty-free-bar {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            height: 32px;
            position: relative;
            overflow: hidden;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .duty-free-bar-fill {
            background: linear-gradient(90deg, #00A896 0%, #028174 100%);
            height: 100%;
            transition: width 0.3s ease;
            position: relative;
            box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.2);
        }

        .duty-free-bar::after {
            content: attr(data-percentage);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 13px;
            pointer-events: none;
            z-index: 1;
        }

        .duty-free-text {
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            opacity: 0.95;
        }

        .duty-free-text strong {
            font-weight: 600;
        }

        /* é…’å“å¡ç‰‡ */
        .bottle-card {
            background-color: #f8f9fa;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        .bottle-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        .bottle-card-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .use-duty-free {
            margin-bottom: 15px;
            padding: 10px;
            background-color: var(--light-green);
            border-radius: 6px;
            display: flex;
            align-items: center;
            border-left: 3px solid var(--primary-color);
        }

        .use-duty-free input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        .use-duty-free label {
            margin-bottom: 0;
            font-weight: normal;
            display: inline;
        }

        .duty-free-usage {
            margin-left: auto;
            color: var(--accent-color);
            font-weight: bold;
            font-size: 12px;
        }

        .tax-info {
            background-color: rgba(74, 111, 165, 0.1);
            padding: 10px;
            border-radius: 4px;
            margin-top: 8px;
            font-size: 13px;
            border-left: 4px solid var(--primary-color);
        }

        .liqueur-options {
            background-color: #fff3cd;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            border-left: 4px solid var(--warning-color);
        }

        .liqueur-options label {
            font-weight: normal;
            margin-bottom: 8px;
        }

        .liqueur-options input[type="radio"] {
            width: auto;
            margin-right: 5px;
        }

        .radio-group {
            margin-top: 8px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .radio-option label {
            margin-bottom: 0;
            margin-left: 5px;
        }

        .other-category-select {
            margin-top: 10px;
            background-color: #fff3cd;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid var(--warning-color);
        }

        /* çµæœé¡¯ç¤º */
        .result {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid var(--primary-color);
        }

        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .result-table th, .result-table td {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            text-align: left;
        }

        .result-table th {
            background-color: rgba(74, 111, 165, 0.1);
            font-weight: bold;
        }

        .highlight {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid var(--accent-color);
        }

        .calculation-details {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #6c757d;
        }

        .hide {
            display: none;
        }

        .savings {
            color: var(--accent-color);
            font-weight: bold;
        }

        .add-bottle-container {
            text-align: center;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .col {
                flex: 100%;
                margin-bottom: 10px;
            }

            body {
                padding: 10px;
            }

            .card {
                padding: 15px;
            }

            .bottle-card {
                padding: 12px;
            }

            .bottle-card-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .btn-danger {
                margin-top: 10px;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>é…’é¡é€²å£ç¨…é‡‘è¨ˆç®—æ©Ÿ - æ—…å®¢ç‰ˆ</h1>
            <p class="subtitle">è¨ˆç®—æ—…å®¢æ”œå¸¶é…’é¡å…¥å¢ƒçš„ç¨…é‡‘æˆæœ¬ï¼ˆå«å…ç¨…é¡è¨ˆç®—ï¼‰</p>
        </header>

        <!-- åŸºæœ¬è¨­å®š -->
        <div class="card">
            <h2>åŸºæœ¬è¨­å®š</h2>
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="passengerCount">å…¥å¢ƒäººæ•¸</label>
                        <input type="number" id="passengerCount" min="1" step="1" value="1">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="currency">å¤–å¹£</label>
                        <select id="currency">
                            <option value="JPY">æ—¥å¹£ (JPY)</option>
                            <option value="USD">ç¾å…ƒ (USD)</option>
                            <option value="EUR">æ­å…ƒ (EUR)</option>
                            <option value="GBP">è‹±éŠ (GBP)</option>
                            <option value="CNY">äººæ°‘å¹£ (CNY)</option>
                            <option value="TWD">æ–°å°å¹£ (TWD)</option>
                            <option value="OTHER">å…¶ä»–è²¨å¹£</option>
                        </select>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="exchangeRate">åŒ¯ç‡ (å…Œæ›æ–°å°å¹£)</label>
                        <input type="number" id="exchangeRate" min="0" step="0.0001" value="0.22">
                        <div style="margin-top: 5px; font-size: 12px; color: #666;">
                            ğŸ’¡ <a href="https://portal.sw.nat.gov.tw/APGQ/GC331" target="_blank" style="color: #006C5E; text-decoration: underline; font-weight: bold;">æŸ¥è©¢æµ·é—œç‰Œå‘Šè³£å‡ºåŒ¯ç‡</a>ï¼ˆæ¯10å¤©æ›´æ–°ï¼‰
                        </div>
                    </div>
                </div>
            </div>

            <div class="duty-free-info">
                <h3>å…ç¨…é¡åº¦</h3>
                <div class="duty-free-bar" data-percentage="0%">
                    <div class="duty-free-bar-fill" id="dutyFreeBar" style="width: 0%"></div>
                </div>
                <div class="duty-free-text">
                    <span>ç¸½é¡åº¦: <strong id="totalDutyFree">1.5</strong> å…¬å‡</span>
                    <span>å·²ä½¿ç”¨: <strong id="usedDutyFree">0</strong> å…¬å‡</span>
                    <span>å‰©é¤˜: <strong id="remainingDutyFree">1.5</strong> å…¬å‡</span>
                </div>
            </div>
        </div>

        <!-- é…’å“æ¸…å–® -->
        <div class="card">
            <h2>é…’å“æ¸…å–®</h2>
            <div id="bottleList">
                <!-- é…’å“å¡ç‰‡å°‡å‹•æ…‹æ’å…¥é€™è£¡ -->
            </div>

            <div class="add-bottle-container">
                <button type="button" class="btn-add" id="addBottleBtn">+ æ–°å¢é…’å“</button>
            </div>

            <button type="button" id="calculateBtn">è¨ˆç®—ç¨…é‡‘</button>
        </div>

        <!-- çµæœå€å¡Š -->
        <div id="resultSection" class="card hide">
            <h2>è¨ˆç®—çµæœ</h2>

            <div class="highlight">
                <h3>ç¸½æˆæœ¬</h3>
                <div id="totalCost" class="savings"></div>
            </div>

            <div id="taxResult"></div>

            <div class="calculation-details">
                <h3 onclick="toggleCalculationDetails()" style="cursor: pointer;">
                    ç¨…é‡‘è¨ˆç®—èªªæ˜ <span id="detailsToggle">[å±•é–‹]</span>
                </h3>
                <div id="calculationDetails" class="hide"></div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€è®Šé‡
        let bottleCount = 0;

        // æ ¼å¼åŒ–æ•¸å­—
        function formatNumber(num) {
            if (num === undefined || num === null) {
                return "0";
            }
            const roundedNum = Math.round(num);
            return roundedNum.toLocaleString('zh-TW');
        }

        // è¨ˆç®—å…ç¨…é¡
        function calculateTotalDutyFree() {
            const passengerCount = parseInt(document.getElementById('passengerCount').value) || 1;
            return passengerCount * 1.5;
        }

        // æ›´æ–°å…ç¨…é¡é¡¯ç¤º
        function updateDutyFreeDisplay() {
            const totalDutyFree = calculateTotalDutyFree();
            let usedDutyFree = 0;

            // è¨ˆç®—å·²ä½¿ç”¨çš„å…ç¨…é¡
            document.querySelectorAll('.bottle-card').forEach(card => {
                const checkbox = card.querySelector('.use-duty-free-checkbox');
                if (checkbox && checkbox.checked) {
                    const volume = parseFloat(card.querySelector('.volume-input').value) || 0;
                    const quantity = parseInt(card.querySelector('.quantity-input').value) || 1;
                    usedDutyFree += (volume * quantity) / 1000; // è½‰æ›ç‚ºå…¬å‡
                }
            });

            const remainingDutyFree = Math.max(0, totalDutyFree - usedDutyFree);
            const percentage = Math.min(100, (usedDutyFree / totalDutyFree) * 100);

            document.getElementById('totalDutyFree').textContent = totalDutyFree.toFixed(1);
            document.getElementById('usedDutyFree').textContent = usedDutyFree.toFixed(2);
            document.getElementById('remainingDutyFree').textContent = remainingDutyFree.toFixed(2);

            const bar = document.querySelector('.duty-free-bar');
            const barFill = document.getElementById('dutyFreeBar');
            const percentageText = percentage.toFixed(1) + '%';

            barFill.style.width = percentageText;
            bar.setAttribute('data-percentage', percentageText);

            // æ›´æ–°æ¯å€‹é…’å“çš„å…ç¨…é¡ä½¿ç”¨é¡¯ç¤º
            let remainingForDisplay = totalDutyFree;
            document.querySelectorAll('.bottle-card').forEach(card => {
                const checkbox = card.querySelector('.use-duty-free-checkbox');
                const usageSpan = card.querySelector('.duty-free-usage');
                if (checkbox && checkbox.checked && usageSpan) {
                    const volume = parseFloat(card.querySelector('.volume-input').value) || 0;
                    const quantity = parseInt(card.querySelector('.quantity-input').value) || 1;
                    const totalVolume = (volume * quantity) / 1000;

                    if (remainingForDisplay > 0) {
                        const usedDutyFree = Math.min(totalVolume, remainingForDisplay);
                        const taxableVolume = totalVolume - usedDutyFree;
                        remainingForDisplay -= usedDutyFree;
                        usageSpan.textContent = `å…± ${totalVolume.toFixed(2)}Lï¼ˆå…ç¨… ${usedDutyFree.toFixed(2)}Lï¼Œæ‡‰ç¨… ${taxableVolume.toFixed(2)}Lï¼‰`;
                    } else {
                        usageSpan.textContent = `å…± ${totalVolume.toFixed(2)}Lï¼ˆæ‡‰ç¨… ${totalVolume.toFixed(2)}Lï¼‰`;
                    }
                } else if (usageSpan) {
                    usageSpan.textContent = '';
                }
            });
        }

        // æ›´æ–°è²¨å¹£åŒ¯ç‡é è¨­å€¼
        function updateCurrencyDefaults() {
            const currency = document.getElementById('currency').value;
            const exchangeRateInput = document.getElementById('exchangeRate');

            switch(currency) {
                case 'JPY':
                    exchangeRateInput.value = '0.22';
                    break;
                case 'USD':
                    exchangeRateInput.value = '31.5';
                    break;
                case 'EUR':
                    exchangeRateInput.value = '34.2';
                    break;
                case 'GBP':
                    exchangeRateInput.value = '40.5';
                    break;
                case 'CNY':
                    exchangeRateInput.value = '4.35';
                    break;
                case 'TWD':
                    exchangeRateInput.value = '1';
                    break;
                default:
                    exchangeRateInput.value = '';
            }
        }

        // ç²å–é…’é¡åˆ†é¡çš„ç¨…ç‡ä¿¡æ¯
        function getTaxRateInfo(category, alcoholPercentage) {
            let taxRateText = '';
            switch(category) {
                case 'fermented-beer':
                    taxRateText = 'é…’ç¨…: 26å…ƒ/å…¬å‡';
                    break;
                case 'fermented-other':
                    taxRateText = `é…’ç¨…: ${alcoholPercentage}åº¦ Ã— 7å…ƒ/åº¦ = ${(alcoholPercentage * 7).toFixed(2)}å…ƒ/å…¬å‡`;
                    break;
                case 'distilled':
                    taxRateText = `é…’ç¨…: ${alcoholPercentage}åº¦ Ã— 2.5å…ƒ/åº¦ = ${(alcoholPercentage * 2.5).toFixed(2)}å…ƒ/å…¬å‡`;
                    break;
                case 'remanufactured-high':
                    taxRateText = 'é…’ç¨…: 185å…ƒ/å…¬å‡ (é…’ç²¾>20%)';
                    break;
                case 'remanufactured-low':
                    taxRateText = `é…’ç¨…: ${alcoholPercentage}åº¦ Ã— 7å…ƒ/åº¦ = ${(alcoholPercentage * 7).toFixed(2)}å…ƒ/å…¬å‡ (é…’ç²¾â‰¤20%)`;
                    break;
                case 'cooking':
                    taxRateText = 'é…’ç¨…: 9å…ƒ/å…¬å‡';
                    break;
                case 'other':
                    taxRateText = `é…’ç¨…: ${alcoholPercentage}åº¦ Ã— 7å…ƒ/åº¦ = ${(alcoholPercentage * 7).toFixed(2)}å…ƒ/å…¬å‡`;
                    break;
                case 'alcohol':
                    taxRateText = 'é…’ç¨…: 15å…ƒ/å…¬å‡';
                    break;
            }
            return taxRateText;
        }

        // æ›´æ–°é…’å“çš„ç¨…ç‡ä¿¡æ¯é¡¯ç¤º
        function updateBottleTaxInfo(bottleCard) {
            const alcoholType = bottleCard.querySelector('.alcohol-type-select').value;
            const alcoholPercentage = parseFloat(bottleCard.querySelector('.alcohol-percentage-input').value) || 0;
            const taxInfoDiv = bottleCard.querySelector('.tax-info');

            let category = '';
            let tariffRate = 0;
            let tariffText = '';

            // æ ¹æ“šé…’é¡è‡ªå‹•è¨­å®šåˆ†é¡å’Œé—œç¨…
            switch(alcoholType) {
                case 'whisky':
                    category = 'distilled';
                    tariffRate = 0;
                    tariffText = 'é—œç¨…: 0%';
                    break;
                case 'wine':
                    category = 'fermented-other';
                    tariffRate = 10;
                    tariffText = 'é—œç¨…: 10%';
                    break;
                case 'beer':
                    category = 'fermented-beer';
                    tariffRate = 0;
                    tariffText = 'é—œç¨…: 0%';
                    break;
                case 'sake':
                    category = 'fermented-other';
                    tariffRate = 20;
                    tariffText = 'é—œç¨…: 20%';
                    break;
                case 'vodka':
                case 'rum':
                case 'gin':
                    category = 'distilled';
                    tariffRate = 20;
                    tariffText = 'é—œç¨…: 20%';
                    break;
                case 'brandy':
                    category = 'distilled';
                    tariffRate = 0;
                    tariffText = 'é—œç¨…: 0%';
                    break;
                case 'liqueur':
                    // åˆ©å£é…’éœ€è¦ç‰¹æ®Šè™•ç†
                    handleLiqueurType(bottleCard);
                    return;
                case 'other':
                    // å…¶ä»–é…’é¡éœ€è¦é¡¯ç¤ºä¸‹æ‹‰é¸å–®
                    handleOtherType(bottleCard);
                    return;
            }

            // å„²å­˜åˆ†é¡åˆ°éš±è—æ¬„ä½
            let categoryInput = bottleCard.querySelector('.category-hidden');
            if (!categoryInput) {
                categoryInput = document.createElement('input');
                categoryInput.type = 'hidden';
                categoryInput.className = 'category-hidden';
                bottleCard.appendChild(categoryInput);
            }
            categoryInput.value = category;

            // è¨­å®šé—œç¨…ç‡
            bottleCard.querySelector('.tariff-rate-input').value = tariffRate;

            // ç§»é™¤åˆ©å£é…’å’Œå…¶ä»–é¡åˆ¥çš„ç‰¹æ®Šå€å¡Š
            const liqueurOptions = bottleCard.querySelector('.liqueur-options');
            if (liqueurOptions) liqueurOptions.remove();
            const otherOptions = bottleCard.querySelector('.other-category-select');
            if (otherOptions) otherOptions.remove();

            // é¡¯ç¤ºç¨…ç‡ä¿¡æ¯
            const taxRateText = getTaxRateInfo(category, alcoholPercentage);
            taxInfoDiv.innerHTML = `ğŸ’¡ <strong>${taxRateText}</strong><br>ğŸ’¡ <strong>${tariffText}</strong>`;
        }

        // è™•ç†åˆ©å£é…’é¡å‹
        function handleLiqueurType(bottleCard) {
            const alcoholPercentage = parseFloat(bottleCard.querySelector('.alcohol-percentage-input').value) || 20;

            // ç§»é™¤å…¶ä»–é¡åˆ¥é¸å–®
            const otherOptions = bottleCard.querySelector('.other-category-select');
            if (otherOptions) otherOptions.remove();

            // æª¢æŸ¥æ˜¯å¦å·²æœ‰åˆ©å£é…’é¸é …
            let liqueurOptions = bottleCard.querySelector('.liqueur-options');
            if (!liqueurOptions) {
                liqueurOptions = document.createElement('div');
                liqueurOptions.className = 'liqueur-options';
                liqueurOptions.innerHTML = `
                    <label><strong>âš™ï¸ åŸºé…’é¡å‹</strong></label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" name="baseType_${bottleCard.dataset.bottleId}" value="distilled" checked>
                            <label>è’¸é¤¾é…’/é…’ç²¾åŸºé…’</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" name="baseType_${bottleCard.dataset.bottleId}" value="other">
                            <label>å…¶ä»–åŸºé…’</label>
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                        ğŸ’¡ é…’ç²¾>15%ä¸”è’¸é¤¾é…’åŸºé…’: 0%<br>
                        ğŸ’¡ é…’ç²¾>20%ä½†éè’¸é¤¾é…’åŸºé…’: 40%<br>
                        ğŸ’¡ å…¶ä»–: 20%
                    </div>
                `;
                bottleCard.querySelector('.tax-info').after(liqueurOptions);

                // æ·»åŠ äº‹ä»¶ç›£è½
                liqueurOptions.querySelectorAll('input[type="radio"]').forEach(radio => {
                    radio.addEventListener('change', () => updateLiqueurTariff(bottleCard));
                });
            }

            updateLiqueurTariff(bottleCard);
        }

        // æ›´æ–°åˆ©å£é…’é—œç¨…
        function updateLiqueurTariff(bottleCard) {
            const alcoholPercentage = parseFloat(bottleCard.querySelector('.alcohol-percentage-input').value) || 0;
            const isDistilledBase = bottleCard.querySelector(`input[name="baseType_${bottleCard.dataset.bottleId}"]:checked`)?.value === 'distilled';

            let tariffRate, category, tariffExplanation;

            if (alcoholPercentage > 15 && isDistilledBase) {
                tariffRate = 0;
                tariffExplanation = '(>15%é…’ç²¾ä¸”è’¸é¤¾é…’åŸºé…’)';
            } else if (alcoholPercentage > 20) {
                tariffRate = 40;
                tariffExplanation = '(>20%é…’ç²¾ä½†éè’¸é¤¾é…’åŸºé…’)';
            } else {
                tariffRate = 20;
                tariffExplanation = '(å…¶ä»–æƒ…æ³)';
            }

            // è¨­å®šåˆ†é¡
            if (alcoholPercentage > 20) {
                category = 'remanufactured-high';
            } else {
                category = 'remanufactured-low';
            }

            // å„²å­˜åˆ†é¡
            let categoryInput = bottleCard.querySelector('.category-hidden');
            if (!categoryInput) {
                categoryInput = document.createElement('input');
                categoryInput.type = 'hidden';
                categoryInput.className = 'category-hidden';
                bottleCard.appendChild(categoryInput);
            }
            categoryInput.value = category;

            // è¨­å®šé—œç¨…ç‡
            bottleCard.querySelector('.tariff-rate-input').value = tariffRate;

            // æ›´æ–°é¡¯ç¤º
            const taxRateText = getTaxRateInfo(category, alcoholPercentage);
            bottleCard.querySelector('.tax-info').innerHTML = `
                ğŸ’¡ <strong>${taxRateText}</strong><br>
                ğŸ’¡ <strong>é—œç¨…: ${tariffRate}% ${tariffExplanation}</strong>
            `;
        }

        // è™•ç†å…¶ä»–é…’é¡
        function handleOtherType(bottleCard) {
            const alcoholPercentage = parseFloat(bottleCard.querySelector('.alcohol-percentage-input').value) || 0;

            // ç§»é™¤åˆ©å£é…’é¸é …
            const liqueurOptions = bottleCard.querySelector('.liqueur-options');
            if (liqueurOptions) liqueurOptions.remove();

            // æª¢æŸ¥æ˜¯å¦å·²æœ‰å…¶ä»–é¡åˆ¥é¸å–®
            let otherOptions = bottleCard.querySelector('.other-category-select');
            if (!otherOptions) {
                otherOptions = document.createElement('div');
                otherOptions.className = 'other-category-select';
                otherOptions.innerHTML = `
                    <label><strong>âš™ï¸ è«‹é¸æ“‡é…’é¡åˆ†é¡</strong></label>
                    <select class="other-category-dropdown">
                        <option value="fermented-beer">é‡€é€ é…’é¡ - å•¤é…’</option>
                        <option value="fermented-other">é‡€é€ é…’é¡ - å…¶ä»–é‡€é€ é…’</option>
                        <option value="distilled">è’¸é¤¾é…’é¡</option>
                        <option value="remanufactured-high">å†è£½é…’é¡ - é…’ç²¾æˆåˆ†è¶…é20%</option>
                        <option value="remanufactured-low">å†è£½é…’é¡ - é…’ç²¾æˆåˆ†20%ä»¥ä¸‹</option>
                        <option value="cooking">æ–™ç†é…’</option>
                        <option value="other">å…¶ä»–é…’é¡</option>
                        <option value="alcohol">é…’ç²¾</option>
                    </select>
                    <div class="form-group" style="margin-top: 10px;">
                        <label>é—œç¨…ç‡ (%)</label>
                        <input type="number" class="other-tariff-input" min="0" max="100" step="0.1" value="0">
                    </div>
                `;
                bottleCard.querySelector('.tax-info').after(otherOptions);

                // æ·»åŠ äº‹ä»¶ç›£è½
                const dropdown = otherOptions.querySelector('.other-category-dropdown');
                dropdown.addEventListener('change', () => updateOtherCategory(bottleCard));

                const tariffInput = otherOptions.querySelector('.other-tariff-input');
                tariffInput.addEventListener('input', () => {
                    bottleCard.querySelector('.tariff-rate-input').value = tariffInput.value;
                });
            }

            updateOtherCategory(bottleCard);
        }

        // æ›´æ–°å…¶ä»–é¡åˆ¥çš„ä¿¡æ¯
        function updateOtherCategory(bottleCard) {
            const dropdown = bottleCard.querySelector('.other-category-dropdown');
            const category = dropdown.value;
            const alcoholPercentage = parseFloat(bottleCard.querySelector('.alcohol-percentage-input').value) || 0;
            const tariffInput = bottleCard.querySelector('.other-tariff-input');

            // å„²å­˜åˆ†é¡
            let categoryInput = bottleCard.querySelector('.category-hidden');
            if (!categoryInput) {
                categoryInput = document.createElement('input');
                categoryInput.type = 'hidden';
                categoryInput.className = 'category-hidden';
                bottleCard.appendChild(categoryInput);
            }
            categoryInput.value = category;

            // åŒæ­¥é—œç¨…ç‡
            bottleCard.querySelector('.tariff-rate-input').value = tariffInput.value;

            // æ›´æ–°é¡¯ç¤º
            const taxRateText = getTaxRateInfo(category, alcoholPercentage);
            bottleCard.querySelector('.tax-info').innerHTML = `ğŸ’¡ <strong>${taxRateText}</strong>`;
        }

        // æ–°å¢é…’å“å¡ç‰‡
        function addBottle() {
            bottleCount++;
            const bottleId = `bottle_${bottleCount}`;

            const bottleCard = document.createElement('div');
            bottleCard.className = 'bottle-card';
            bottleCard.dataset.bottleId = bottleId;

            bottleCard.innerHTML = `
                <div class="bottle-card-header">
                    <div class="bottle-card-title">é…’å“ ${bottleCount}</div>
                    <button type="button" class="btn-danger delete-bottle-btn">åˆªé™¤</button>
                </div>

                <div class="use-duty-free">
                    <input type="checkbox" class="use-duty-free-checkbox" id="useDutyFree_${bottleId}">
                    <label for="useDutyFree_${bottleId}">ä½¿ç”¨å…ç¨…é¡</label>
                    <span class="duty-free-usage"></span>
                </div>

                <div class="form-group">
                    <label>é…’é¡ç¨®é¡</label>
                    <select class="alcohol-type-select">
                        <option value="whisky">å¨å£«å¿Œ</option>
                        <option value="wine">è‘¡è„é…’</option>
                        <option value="beer">å•¤é…’</option>
                        <option value="sake">æ¸…é…’</option>
                        <option value="vodka">ä¼ç‰¹åŠ </option>
                        <option value="rum">è˜­å§†é…’</option>
                        <option value="gin">ç´é…’</option>
                        <option value="liqueur">åˆ©å£é…’</option>
                        <option value="brandy">ç™½è˜­åœ°</option>
                        <option value="other">å…¶ä»–</option>
                    </select>
                </div>

                <div class="tax-info"></div>

                <div class="row">
                    <div class="col">
                        <div class="form-group">
                            <label>é…’ç²¾åº¦æ•¸ (%)</label>
                            <input type="number" class="alcohol-percentage-input" min="0" max="100" step="0.1" value="40">
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label>å®¹é‡ (ml)</label>
                            <input type="number" class="volume-input" min="0" step="1" value="700">
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col">
                        <div class="form-group">
                            <label>å–®åƒ¹ (å¤–å¹£/ç“¶)</label>
                            <input type="number" class="price-input" min="0" step="0.01" placeholder="ä¾‹ï¼š5000">
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label>æ•¸é‡ (ç“¶)</label>
                            <input type="number" class="quantity-input" min="1" step="1" value="1">
                        </div>
                    </div>
                </div>

                <input type="hidden" class="tariff-rate-input" value="0">
            `;

            document.getElementById('bottleList').appendChild(bottleCard);

            // æ·»åŠ äº‹ä»¶ç›£è½
            const alcoholTypeSelect = bottleCard.querySelector('.alcohol-type-select');
            alcoholTypeSelect.addEventListener('change', () => {
                updateBottleTaxInfo(bottleCard);
            });

            const alcoholPercentageInput = bottleCard.querySelector('.alcohol-percentage-input');
            alcoholPercentageInput.addEventListener('input', () => {
                updateBottleTaxInfo(bottleCard);
            });

            const volumeInput = bottleCard.querySelector('.volume-input');
            volumeInput.addEventListener('input', () => {
                updateDutyFreeDisplay();
            });

            const dutyFreeCheckbox = bottleCard.querySelector('.use-duty-free-checkbox');
            dutyFreeCheckbox.addEventListener('change', () => {
                updateDutyFreeDisplay();
            });

            const deleteBtn = bottleCard.querySelector('.delete-bottle-btn');
            deleteBtn.addEventListener('click', () => {
                bottleCard.remove();
                updateDutyFreeDisplay();
                renumberBottles();
            });

            // åˆå§‹åŒ–ç¨…ç‡ä¿¡æ¯
            updateBottleTaxInfo(bottleCard);
        }

        // é‡æ–°ç·¨è™Ÿé…’å“
        function renumberBottles() {
            const bottles = document.querySelectorAll('.bottle-card');
            bottles.forEach((bottle, index) => {
                bottle.querySelector('.bottle-card-title').textContent = `é…’å“ ${index + 1}`;
            });
        }

        // åˆ‡æ›è¨ˆç®—è©³æƒ…
        function toggleCalculationDetails() {
            const details = document.getElementById('calculationDetails');
            const toggle = document.getElementById('detailsToggle');
            const isHidden = details.classList.contains('hide');

            details.classList.toggle('hide', !isHidden);
            toggle.textContent = isHidden ? '[æ”¶åˆ]' : '[å±•é–‹]';
        }

        // è¨ˆç®—ç¨…é‡‘
        function calculateTax() {
            try {
                const bottles = document.querySelectorAll('.bottle-card');
                if (bottles.length === 0) {
                    alert('è«‹è‡³å°‘æ–°å¢ä¸€å€‹é…’å“');
                    return;
                }

                const exchangeRate = parseFloat(document.getElementById('exchangeRate').value) || 0;
                const currency = document.getElementById('currency').value;

                if (exchangeRate <= 0) {
                    alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„åŒ¯ç‡');
                    return;
                }

                // æ”¶é›†æ‰€æœ‰é…’å“è³‡æ–™
                const bottleData = [];
                let hasError = false;

                bottles.forEach((bottle, index) => {
                    const alcoholPercentage = parseFloat(bottle.querySelector('.alcohol-percentage-input').value) || 0;
                    const volume = parseFloat(bottle.querySelector('.volume-input').value) || 0;
                    const price = parseFloat(bottle.querySelector('.price-input').value) || 0;
                    const quantity = parseInt(bottle.querySelector('.quantity-input').value) || 1;
                    const tariffRate = parseFloat(bottle.querySelector('.tariff-rate-input').value) || 0;
                    const useDutyFree = bottle.querySelector('.use-duty-free-checkbox').checked;
                    const alcoholType = bottle.querySelector('.alcohol-type-select').value;
                    const categoryInput = bottle.querySelector('.category-hidden');
                    const category = categoryInput ? categoryInput.value : 'other';

                    if (alcoholPercentage <= 0 || volume <= 0 || price <= 0) {
                        alert(`é…’å“ ${index + 1} çš„è³‡æ–™ä¸å®Œæ•´ï¼ˆåº¦æ•¸ã€å®¹é‡å’Œå–®åƒ¹å¿…å¡«ï¼‰`);
                        hasError = true;
                        return;
                    }

                    bottleData.push({
                        index: index + 1,
                        alcoholType,
                        category,
                        alcoholPercentage,
                        volume,
                        price,
                        quantity,
                        tariffRate,
                        useDutyFree
                    });
                });

                if (hasError) return;

                // è™•ç†å…ç¨…é¡åˆ†é…
                const totalDutyFree = calculateTotalDutyFree();
                let remainingDutyFree = totalDutyFree;

                // è¨ˆç®—æ¯å€‹é…’å“çš„ç¨…é‡‘
                let totalPurchaseCost = 0;
                let totalAlcoholTax = 0;
                let totalTariff = 0;
                let totalTradeFee = 0;
                let totalVAT = 0;
                let bottleResults = [];

                bottleData.forEach(bottle => {
                    const volumeInLiters = bottle.volume / 1000;
                    const purchaseCost = bottle.price * exchangeRate * bottle.quantity;

                    // è¨ˆç®—é…’ç¨…ï¼ˆæ¯å…¬å‡ï¼‰
                    let alcoholTaxPerLiter = 0;
                    switch (bottle.category) {
                        case 'fermented-beer':
                            alcoholTaxPerLiter = 26;
                            break;
                        case 'fermented-other':
                            alcoholTaxPerLiter = 7 * bottle.alcoholPercentage;
                            break;
                        case 'distilled':
                            alcoholTaxPerLiter = 2.5 * bottle.alcoholPercentage;
                            break;
                        case 'remanufactured-high':
                            alcoholTaxPerLiter = 185;
                            break;
                        case 'remanufactured-low':
                            alcoholTaxPerLiter = 7 * bottle.alcoholPercentage;
                            break;
                        case 'cooking':
                            alcoholTaxPerLiter = 9;
                            break;
                        case 'other':
                            alcoholTaxPerLiter = 7 * bottle.alcoholPercentage;
                            break;
                        case 'alcohol':
                            alcoholTaxPerLiter = 15;
                            break;
                    }

                    // è™•ç†å…ç¨…é¡
                    let dutyFreeVolume = 0;
                    let taxableVolume = volumeInLiters * bottle.quantity;
                    let totalVolume = volumeInLiters * bottle.quantity;

                    if (bottle.useDutyFree && remainingDutyFree > 0) {
                        dutyFreeVolume = Math.min(taxableVolume, remainingDutyFree);
                        taxableVolume -= dutyFreeVolume;
                        remainingDutyFree -= dutyFreeVolume;
                    }

                    // è¨ˆç®—æ‡‰ç¨…æ¯”ä¾‹å’Œæ‡‰ç¨…è³¼è²·æˆæœ¬
                    const taxableRatio = totalVolume > 0 ? taxableVolume / totalVolume : 1;
                    const taxablePurchaseCost = purchaseCost * taxableRatio;

                    // è¨ˆç®—é…’ç¨…ï¼ˆåªå°è¶…éå…ç¨…é¡çš„éƒ¨åˆ†èª²ç¨…ï¼‰
                    const alcoholTax = alcoholTaxPerLiter * taxableVolume;

                    // é—œç¨…åªå°æ‡‰ç¨…è³¼è²·æˆæœ¬è¨ˆç®—
                    const tariff = taxablePurchaseCost * (bottle.tariffRate / 100);

                    // æ¨å»£è²»åªå°æ‡‰ç¨…è³¼è²·æˆæœ¬è¨ˆç®—ï¼Œä¸” < 100 ä¸æ”¶
                    let tradeFee = taxablePurchaseCost * 0.0004;
                    if (tradeFee < 100) {
                        tradeFee = 0;
                    }

                    // ç‡Ÿæ¥­ç¨…åŸºç¤æ”¹ç‚ºæ‡‰ç¨…è³¼è²·æˆæœ¬
                    const subtotalForVAT = taxablePurchaseCost + alcoholTax + tariff + tradeFee;
                    const vat = subtotalForVAT * 0.05;

                    totalPurchaseCost += purchaseCost;
                    totalAlcoholTax += alcoholTax;
                    totalTariff += tariff;
                    totalTradeFee += tradeFee;
                    totalVAT += vat;

                    bottleResults.push({
                        ...bottle,
                        purchaseCost,
                        alcoholTaxPerLiter,
                        dutyFreeVolume,
                        taxableVolume,
                        alcoholTax,
                        tariff,
                        tradeFee,
                        vat,
                        totalCost: purchaseCost + alcoholTax + tariff + tradeFee + vat,
                        volumeInLiters
                    });
                });

                const totalTax = totalAlcoholTax + totalTariff + totalTradeFee + totalVAT;
                const grandTotal = totalPurchaseCost + totalTax;

                // é¡¯ç¤ºçµæœ
                document.getElementById('totalCost').innerHTML = `
                    <h3 style="font-size: 24px; margin-bottom: 10px;">${formatNumber(grandTotal)} å…ƒ</h3>
                    <p>è³¼è²·æˆæœ¬: ${formatNumber(totalPurchaseCost)} å…ƒ + ç¸½ç¨…é‡‘: ${formatNumber(totalTax)} å…ƒ</p>
                `;

                // é¡¯ç¤ºè©³ç´°è¨ˆç®—è¡¨æ ¼
                let resultHTML = '<h3>é…’å“æ˜ç´°</h3><table class="result-table"><tr><th>é…’å“</th><th>å®¹é‡æ˜ç´°</th><th>è³¼è²·æˆæœ¬</th><th>é…’ç¨…</th><th>é—œç¨…</th><th>æ¨å»£è²»</th><th>ç‡Ÿæ¥­ç¨…</th><th>å°è¨ˆ</th></tr>';

                bottleResults.forEach(bottle => {
                    const bottleTypeName = document.querySelector(`option[value="${bottle.alcoholType}"]`).textContent;
                    const totalVol = bottle.volumeInLiters * bottle.quantity;
                    const dutyFreeVol = bottle.dutyFreeVolume;
                    const taxableVol = bottle.taxableVolume;

                    let volumeDetail = `ç¸½ ${totalVol.toFixed(2)}L`;
                    if (dutyFreeVol > 0) {
                        volumeDetail += `<br><span style="color: #00A896; font-size: 12px;">å…ç¨… ${dutyFreeVol.toFixed(2)}L</span>`;
                        volumeDetail += `<br><span style="color: #E68A00; font-size: 12px;">æ‡‰ç¨… ${taxableVol.toFixed(2)}L</span>`;
                    } else {
                        volumeDetail += `<br><span style="color: #E68A00; font-size: 12px;">æ‡‰ç¨… ${taxableVol.toFixed(2)}L</span>`;
                    }

                    resultHTML += `
                        <tr>
                            <td>${bottleTypeName} x${bottle.quantity}</td>
                            <td>${volumeDetail}</td>
                            <td>${formatNumber(bottle.purchaseCost)}</td>
                            <td>${formatNumber(bottle.alcoholTax)}</td>
                            <td>${formatNumber(bottle.tariff)}</td>
                            <td>${formatNumber(bottle.tradeFee)}</td>
                            <td>${formatNumber(bottle.vat)}</td>
                            <td><strong>${formatNumber(bottle.totalCost)}</strong></td>
                        </tr>
                    `;
                });

                const totalUsedDutyFree = totalDutyFree - remainingDutyFree;
                let totalVolumeSum = 0;
                let totalTaxableSum = 0;
                bottleResults.forEach(bottle => {
                    totalVolumeSum += bottle.volumeInLiters * bottle.quantity;
                    totalTaxableSum += bottle.taxableVolume;
                });

                resultHTML += `
                    <tr style="background-color: rgba(0, 108, 94, 0.1); font-weight: bold;">
                        <td>ç¸½è¨ˆ</td>
                        <td>ç¸½ ${totalVolumeSum.toFixed(2)}L<br><span style="color: #00A896; font-size: 12px;">å…ç¨… ${totalUsedDutyFree.toFixed(2)}L</span><br><span style="color: #E68A00; font-size: 12px;">æ‡‰ç¨… ${totalTaxableSum.toFixed(2)}L</span></td>
                        <td>${formatNumber(totalPurchaseCost)}</td>
                        <td>${formatNumber(totalAlcoholTax)}</td>
                        <td>${formatNumber(totalTariff)}</td>
                        <td>${formatNumber(totalTradeFee)}</td>
                        <td>${formatNumber(totalVAT)}</td>
                        <td><strong>${formatNumber(grandTotal)}</strong></td>
                    </tr>
                </table>`;

                document.getElementById('taxResult').innerHTML = resultHTML;

                // é¡¯ç¤ºè¨ˆç®—èªªæ˜
                let detailsHTML = '<p><strong>ç¨…é‡‘è¨ˆç®—èªªæ˜ï¼š</strong></p><ol>';
                detailsHTML += '<li>è³¼è²·æˆæœ¬ = å–®åƒ¹ Ã— åŒ¯ç‡ Ã— æ•¸é‡</li>';
                detailsHTML += '<li>å…ç¨…é¡ = å…¥å¢ƒäººæ•¸ Ã— 1.5å…¬å‡ï¼ˆå‹¾é¸ã€Œä½¿ç”¨å…ç¨…é¡ã€çš„é…’å“å„ªå…ˆæ‰£é™¤ï¼‰</li>';
                detailsHTML += '<li>æ‡‰ç¨…æ¯”ä¾‹ = (ç¸½å®¹é‡ - å…ç¨…å®¹é‡) / ç¸½å®¹é‡</li>';
                detailsHTML += '<li>æ‡‰ç¨…è³¼è²·æˆæœ¬ = è³¼è²·æˆæœ¬ Ã— æ‡‰ç¨…æ¯”ä¾‹</li>';
                detailsHTML += '<li>é…’ç¨… = æ¯å…¬å‡ç¨…ç‡ Ã— æ‡‰ç¨…å®¹é‡ï¼ˆæ‰£é™¤å…ç¨…é¡å¾Œçš„å®¹é‡ï¼‰</li>';
                detailsHTML += '<li>é—œç¨… = æ‡‰ç¨…è³¼è²·æˆæœ¬ Ã— é—œç¨…ç‡</li>';
                detailsHTML += '<li>æ¨å»£è²¿æ˜“æœå‹™è²» = æ‡‰ç¨…è³¼è²·æˆæœ¬ Ã— 0.04%ï¼ˆä½æ–¼100å…ƒå‰‡ä¸æ”¶è²»ï¼‰</li>';
                detailsHTML += '<li>ç‡Ÿæ¥­ç¨… = (æ‡‰ç¨…è³¼è²·æˆæœ¬ + é…’ç¨… + é—œç¨… + æ¨å»£è²») Ã— 5%</li>';
                detailsHTML += '<li>ç¸½æˆæœ¬ = è³¼è²·æˆæœ¬ + é…’ç¨… + é—œç¨… + æ¨å»£è²» + ç‡Ÿæ¥­ç¨…</li>';
                detailsHTML += '</ol>';
                detailsHTML += '<p style="margin-top: 15px; color: #666; font-size: 14px;">ğŸ’¡ <strong>å…ç¨…é¡è¨ˆç®—èªªæ˜ï¼š</strong>åœ¨å…ç¨…é¡å…§çš„éƒ¨åˆ†ï¼Œè³¼è²·æˆæœ¬æŒ‰æ¯”ä¾‹è¨ˆç®—ç‚ºã€Œå…ç¨…ã€å’Œã€Œæ‡‰ç¨…ã€å…©éƒ¨åˆ†ï¼Œåªå°æ‡‰ç¨…éƒ¨åˆ†èª²ç¨…ã€‚</p>';

                document.getElementById('calculationDetails').innerHTML = detailsHTML;

                // é¡¯ç¤ºçµæœå€åŸŸ
                document.getElementById('resultSection').classList.remove('hide');

            } catch (error) {
                console.error('è¨ˆç®—éŒ¯èª¤:', error);
                alert('è¨ˆç®—éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥è¼¸å…¥è³‡æ–™');
            }
        }

        // é é¢åŠ è¼‰å®Œæˆå¾ŒåŸ·è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–
            updateCurrencyDefaults();
            updateDutyFreeDisplay();

            // æ·»åŠ ç¬¬ä¸€å€‹é…’å“
            addBottle();

            // äº‹ä»¶ç›£è½
            document.getElementById('currency').addEventListener('change', updateCurrencyDefaults);
            document.getElementById('passengerCount').addEventListener('input', updateDutyFreeDisplay);
            document.getElementById('addBottleBtn').addEventListener('click', addBottle);
            document.getElementById('calculateBtn').addEventListener('click', calculateTax);
        });
    </script>
</body>
</html>
